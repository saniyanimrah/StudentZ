<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - CampusConnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Simple scrollbar for post feed */
        main::-webkit-scrollbar { width: 4px; }
        main::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 20px; }
        /* Custom styles for mobile bottom nav */
        @media (max-width: 767px) {
            body { padding-bottom: 64px; } /* Space for fixed bottom nav */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- Header / Navigation Bar -->
    <header class="bg-gray-800 shadow-md sticky top-0 z-50">
        <nav class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="#" class="text-2xl font-bold text-blue-400">CampusConnect</a>
                </div>

                <!-- Search & Icons (Right Side) -->
                <div class="flex items-center space-x-2 sm:space-x-4">
                    
                    <!-- Search Bar (Desktop) -->
                    <div class="flex-1 max-w-xs hidden sm:block">
                        <label for="search" class="sr-only">Search</label>
                        <input type="search" id="search" placeholder="Search..."
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Messages Icon -->
                    <button class="p-2 rounded-full text-gray-400 hover:text-white hover:bg-gray-700">
                        <span class="sr-only">Messages</span>
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443H18.38a2.25 2.25 0 002.25-2.25V6.108c0-1.138-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08H4.25a2.25 2.25 0 00-2.25 2.25v6.652z" />
                        </svg>
                    </button>

                    <!-- Notification Icon -->
                    <button class="p-2 rounded-full text-gray-400 hover:text-white hover:bg-gray-700">
                        <span class="sr-only">Notifications</span>
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
                    </button>

                    <!-- Profile/Settings Dropdown -->
                    <div class="relative" data-dropdown="profile">
                        <button type="button" class="flex items-center rounded-full" data-dropdown-toggle="profile">
                            <span class="sr-only">Open settings menu</span>
                            <img id="nav-profile-pic" class="h-9 w-9 rounded-full bg-gray-600" 
                                 src="https://placehold.co/100x100/E0E7FF/4F46E5?text=..." alt="User profile picture">
                        </button>
                        <!-- Dropdown Menu -->
                        <div class="absolute right-0 z-10 mt-2 w-56 origin-top-right bg-gray-700 rounded-md shadow-lg py-1 hidden" data-dropdown-menu="profile">
                            <div class="px-4 py-3 border-b border-gray-600">
                                <p class="text-sm text-white">Signed in as</p>
                                <p id="nav-user-name" class="text-sm font-medium text-gray-300 truncate">Loading...</p>
                            </div>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">View Profile</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Settings</a>
                            
                            <!-- Campus Services moved inside settings -->
                            <div class="border-t border-gray-600 my-1"></div>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Trading</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Xerox</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Lost & Found</a>
                            <div class="border-t border-gray-600 my-1"></div>
                            
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-400 hover:bg-gray-600">Sign out</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto max-w-3xl p-4 pt-6">
        
        <!-- Search Bar (Mobile) -->
        <div class="sm:hidden mb-4">
            <label for="search-mobile" class="sr-only">Search</label>
            <input type="search" id="search-mobile" placeholder="Search..."
                   class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-sm focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Create Post Box -->
        <div class="bg-gray-800 rounded-2xl shadow-lg p-4 mb-6">
            <div class="flex items-center space-x-3">
                <img id="post-box-profile-pic" class="h-10 w-10 rounded-full bg-gray-600" 
                     src="https://placehold.co/100x100/E0E7FF/4F46E5?text=..." alt="Your profile picture">
                <button class="w-full bg-gray-700 hover:bg-gray-600 text-gray-400 text-left rounded-full py-3 px-4 transition-colors">
                    What's on your mind?
                </button>
            </div>
        </div>

        <!-- Post Feed -->
        <h2 class="text-xl font-bold text-gray-200 mb-4">Recent Posts & Ideas</h2>
        <div id="post-feed" class="space-y-6">
            <!-- Loading Spinner -->
            <div id="feed-loading" class="text-center py-10">
                <p class="text-gray-400">Loading posts...</p>
            </div>
            <!-- Posts will be injected here by JavaScript -->
        </div>

    </main>
    
    <!-- Mobile Bottom Nav Bar (Main Navigation) -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 shadow-lg border-t border-gray-700 flex justify-around h-16 items-center">
        <!-- Home -->
        <a href="#" class="p-3 text-blue-400" aria-label="Home">
            <svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" /><path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" /></svg>
        </a>
        <!-- Messages -->
        <a href="#" class="p-3 text-gray-400 hover:text-blue-400" aria-label="Messages">
            <svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443H18.38a2.25 2.25 0 002.25-2.25V6.108c0-1.138-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08H4.25a2.25 2.25 0 00-2.25 2.25v6.652z" /></svg>
        </a>
        <!-- Notifications -->
        <a href="#" class="p-3 text-gray-400 hover:text-blue-400" aria-label="Notifications">
            <svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
        </a>
        <!-- Settings (Profile) -->
        <a href="#" class="p-3 text-gray-400 hover:text-blue-400" aria-label="Settings" data-dropdown-toggle="profile-mobile">
            <svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </a>
    </nav>

    <script>
        // --- CONFIG ---
        const API_BASE_URL = 'http://localhost:5000'; // Make sure this matches your API

        // --- ELEMENTS ---
        const navProfilePic = document.getElementById('nav-profile-pic');
        const postBoxProfilePic = document.getElementById('post-box-profile-pic');
        const navUserName = document.getElementById('nav-user-name');
        const postFeed = document.getElementById('post-feed');
        const feedLoading = document.getElementById('feed-loading');
        
        /**
         * 1. SECURITY: Check if user is logged in
         */
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.log('No token found, redirecting to login.');
                window.location.href = './login.html'; // Use relative path
                return null;
            }
            return token;
        }

        /**
         * 2. Handles bad authentication (e.g., expired token)
         */
        function handleAuthError() {
            localStorage.removeItem('authToken');
            alert('Your session has expired. Please log in again.');
            window.location.href = './login.html'; // Use relative path
        }

        /**
         * 3. Fetches the current user's info for the nav bar
         */
        async function fetchMyInfo(token) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.status === 401) { handleAuthError(); return; }
                if (!response.ok) { throw new Error('Failed to fetch user info'); }
                const user = await response.json();
                
                const placeholder = 'https://placehold.co/100x100/E0E7FF/4F46E5?text=ME';
                const picUrl = user.profilePicUrl ? `${API_BASE_URL}/${user.profilePicUrl}` : placeholder;

                navProfilePic.src = picUrl;
                postBoxProfilePic.src = picUrl;
                navUserName.textContent = user.fullName || 'Student';

            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }

        /**
         * 4. Fetches all public posts for the feed
         */
        async function fetchPublicPosts(token) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/posts/public`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.status === 401) { handleAuthError(); return; }
                if (!response.ok) { throw new Error('Failed to fetch posts'); }
                const posts = await response.json();
                
                feedLoading.classList.add('hidden');
                if (posts.length === 0) {
                    postFeed.innerHTML = '<p class="text-center text-gray-400">No posts yet. Be the first!</p>';
                } else {
                    posts.forEach(post => {
                        const postCard = createPostCard(post);
                        postFeed.appendChild(postCard);
                    });
                }
            } catch (error) {
                console.error('Error fetching posts:', error);
                feedLoading.textContent = 'Error loading posts.';
            }
        }
        
        /**
         * 5. Creates the HTML for a single post card
         */
        function createPostCard(post) {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-2xl shadow-lg p-5';
            const postDate = new Date(post.created_at);
            const dateString = postDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            const timeString = postDate.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
            const authorPic = post.authorPicUrl.startsWith('http') 
                ? post.authorPicUrl 
                : `${API_BASE_URL}/${post.authorPicUrl}`;
            const typeBadge = post.post_type === 'idea'
                ? `<span class="bg-blue-600 text-blue-100 text-xs font-semibold px-2.5 py-0.5 rounded-full">Idea</span>`
                : `<span class="bg-green-600 text-green-100 text-xs font-semibold px-2.5 py-0.5 rounded-full">Post</span>`;

            card.innerHTML = `
                <div class="flex items-center space-x-3 mb-4">
                    <img class="h-10 w-10 rounded-full bg-gray-600" src="${authorPic}" alt="${post.authorName}'s profile picture">
                    <div>
                        <p class="text-sm font-semibold text-white">${post.authorName}</p>
                        <p class="text-xs text-gray-400">${dateString} at ${timeString}</p>
                    </div>
                </div>
                <p class="text-gray-200 whitespace-pre-wrap mb-4">${post.content}</p>
                <div class="flex justify-between items-center border-t border-gray-700 pt-3">
                    ${typeBadge}
                    <div class="flex space-x-4 text-gray-400">
                        <button class="flex items-center space-x-1 hover:text-blue-400">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
                            <span class="text-sm">Like</span>
                        </button>
                        <button class="flex items-center space-x-1 hover:text-blue-400">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443H18.38a2.25 2.25 0 002.25-2.25V6.108c0-1.138-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08H4.25a2.25 2.25 0 00-2.25 2.25v6.652z" /></svg>
                            <span class="text-sm">Comment</span>
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        /**
         * 6. Add all event listeners
         */
        function setupEventListeners() {
            // Logout Button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('authToken');
                    window.location.href = './login.html'; // Use relative path
                });
            }

            // Dropdown Toggles
            // This now handles both the desktop and mobile profile/settings
            document.querySelectorAll('[data-dropdown-toggle]').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    // Find the 'profile' dropdown, whether in desktop or mobile
                    const menu = document.querySelector('[data-dropdown-menu="profile"]');
                    if(menu) menu.classList.toggle('hidden');
                });
            });

            // Close dropdowns if clicking outside
            window.addEventListener('click', (e) => {
                document.querySelectorAll('[data-dropdown]').forEach(dropdown => {
                    if (!dropdown.contains(e.target)) {
                        dropdown.querySelector('[data-dropdown-menu]').classList.add('hidden');
                    }
                });
            });
        }

        // --- RUN ON PAGE LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            const token = checkAuthentication();
            if (token) {
                // If logged in, fetch data and set up the page
                fetchMyInfo(token);
                fetchPublicPosts(token);
                setupEventListeners();
            }
        });
    </script>
</body>
</html>

